---
title: Vite 核心特性分析

tableOfContents:
  minHeadingLevel: 2
  maxHeadingLevel: 5
---

本文主要对`Vite`的核心特性进行记录，也就是`Vite`的优点。

## 双引擎架构

`Vite`的双引擎架构指的是其在开发环境与生产环境分别采用了两套不同的构建引擎：

- 开发环境（Dev Server）：基于原生`ES Module`（ESM）的`No-Bundle`服务。利用浏览器原生支持`ES Module`的特性，`Vite`的开发服务器直接将源码中的模块请求（如`import React from 'react'`）转换成浏览器可以识别的 ES Module 请求。

- 生产环境（Build）：基于`Rollup`的打包构建。在构建用于生产环境的代码时，`Vite`会切换到 Rollup。`Rollup`是一个成熟且高效的 `JavaScript`模块打包器，在生成优化后的静态资源（如代码分割、`Tree-shaking`）方面表现出色。

简单来说，开发用 ESM，生产用 Rollup，这就是 Vite 双引擎架构的核心。

## 开发环境（基于 Esbuild）

### No Bundle

与传统打包器（如`Webpack`）启动时先打包整个应用不同，`Vite`的开发服务器直接将源代码中的裸模块导入（如`import React from 'react'`）交给浏览器处理，这就是`Vite`在开发环境构建的核心理念`No Bundle`。

`No Bundle`有如下好处：

1. 更快的冷启动：`No Bundle`下只有浏览器请求某个模块时，该模块才会被编译。因此启动时并不需要对整个应用进行全量打包，只需要启动`devServer`即可，节省了大量时间

2. 更快的`HMR`：当一个模块失效时（开发者修改代码并保存时），`Vite`只需要精确地让该模块和其直接依赖的`HMR`边界链失效。这意味着它只需要处理很少的模块，然后通过`WebSocket`推送更新消息，浏览器直接发起新的`ESM`请求获取新模块即可。这个过程的开销与项目总大小无关，只与当前修改的模块本身的大小有关，因此速度极快且稳定。

### 依赖预构建

`Vite`在首次启动开发服务器时，会先扫描项目源码，识别出用到的第三方依赖（`node_modules`中的包），然后使用`Esbuild`将这些依赖的代码提前进行编译和打包。这个过程就是依赖预构建。

依赖预构建的目的有两个：

- 将以`CommonJS`或`UMD`形式提供的依赖项转换为`ES`模块。

- 将某个依赖项及其自身的依赖，打包成一个单一的`ESM`文件，以减小`http`请求压力。

有如下好处：

1. 兼容非 ESM 格式的依赖

2. 提升加载速度（解决请求瀑布流问题）：许多第三方库会将其内部代码拆分成大量的小文件（例如`lodash-es`有`600+`个模块）。如果不做处理，浏览器直接加载这些文件会产生海量的`HTTP`请求，导致明显的请求瀑布流，拖慢页面加载速度。

3. 优化缓存和后续性能：依赖预构建后的产物存放在`node_modules/.vite`中，依赖不变的情况下，二次启动无需再次进行依赖预构建（文件系统缓存）

### 热模块替换 HMR

`Vite`下的`HMR`的工作流程如下：

- 服务器与浏览器之间通过`WebSocket`建立连接。

- 当文件被修改时，`Vite`的插件（如`vite-plugin-vue`）会计算出被影响模块的`HMR`边界，并通过`WebSocket`推送一条更新信息通知浏览器重新对模块进行加载。

- 浏览器接收到信息后，只会动态导入发生变化的模块，而不需要刷新整个页面。这个过程非常快，因为不需要重新打包，只是重新请求了几个独立的模块。

`Webpack`下的`HMR`更新的单位是`bundle`，在项目规模较大的情况下耗时较长，相比之下`Vite`受益于`ESM`，能更精确地识别出被修改的单个模块，因此需要增量构建的内容更小。加上`esbuild`具备更快的构建速度，`Vite`的`HMR`的优势是远大于`webpack`的。

## 生产环境（基于 Rollup）

在生产环境下，`Vite`使用`Rollup`进行构建。

相较于直接使用`Rollup`，`Vite`做了如下增强/简化：

- 开箱即用，预设了最优化的构建配置

  - 自动代码分割 (`Code Splitting`)：`Vite`内置了高效的代码分割策略。它会自动为异步导入（`import()`）的模块创建`chunk`，并对第三方依赖（`node_modules`）进行智能分割，生成稳定的`vendor chunk`，充分利用浏览器缓存。

  - 资源处理 (`Asset Handling`)：`Vite`内置了对静态资源（如图片、字体、`JSON`）的处理。你无需安装和配置额外的插件，即可使用`import`导入资源，并根据大小决定是内联为`base64`还是输出为文件。它还提供了构建资产版本哈希，利于长期缓存。
  - `CSS`处理：`Vite`对`CSS`提供了强大的开箱即用支持：

    - `CSS`代码分割：会自动为异步加载的组件提取`CSS`到单独的文件，避免通过`JavaScript`插入样式带来的闪屏问题。

    - PostCSS 集成：默认支持`PostCSS`。

    - CSS Preprocessors：内置了对`.scss`,`.sass`,`.less`,`.styl`等预处理器支持，无需为构建额外配置插件。

- 开发/生产配置一致性：开发/生产使用同一套解析和插件规则

- 内置多种文件格式（`jsx`、`tsx`等）的支持，提供了现代化项目所需的全部功能